# Merkle 树计算工具

这个工具用于计算指定目录中所有文件的 Merkle 树，并输出根哈希值。

## 什么是 Merkle 树？

Merkle 树（也称为哈希树）是一种树形数据结构，每个叶子节点都是数据块的哈希值，而每个非叶子节点都是其子节点的哈希值的组合。Merkle 树的根节点包含整个数据结构的哈希值。

主要特点：
- 高效验证大型数据集的完整性
- 支持快速检测数据篡改
- 可用于证明特定数据存在性
- 广泛应用于区块链、分布式系统、版本控制等领域

## 安装

```bash
go get github.com/wangtengda0310/gobee/lvan/cmd/merkle
```

或者从源码编译：

```bash
git clone https://github.com/wangtengda0310/gobee.git
cd gobee/lvan/cmd/merkle
go build
```

## 使用方法

基本用法：

```bash
merkle [选项] <目录路径>
```

### 选项

- `--hash`: 指定要使用的哈希算法（默认：sha256）
  - 支持的算法：md5, sha1, sha256, sha512, blake2b, crc32, sm3

- `--output`, `-o`: 指定输出文件路径（默认：标准输出）

- `--exclude`: 指定要排除的文件或目录模式（可多次使用）
  - 例如：`--exclude "*.tmp" --exclude ".git"`

- `--include-empty-dir`: 是否包含空目录（默认：false）

- `--verbose`, `-v`: 显示详细输出

- `--help`, `-h`: 显示帮助信息

- `--version`: 显示版本信息

- `--workers`: 指定并发工作线程数量（默认为CPU核心数）
  - 例如：`--workers 4`

- `--disable-parallel`: 禁用并行计算（使用串行模式）

### 示例

计算当前目录的 Merkle 树（使用默认的 SHA256 算法）：
```bash
merkle .
```

使用 SHA1 算法计算指定目录的 Merkle 树：
```bash
merkle --hash sha1 /path/to/directory
```

使用 CRC32 算法计算指定目录的 Merkle 树（性能优先）：
```bash
merkle --hash crc32 /path/to/directory
```

使用 SM3 国密算法计算指定目录的 Merkle 树：
```bash
merkle --hash sm3 /path/to/directory
```

排除临时文件和 .git 目录：
```bash
merkle --exclude "*.tmp" --exclude ".git" /path/to/directory
```

将结果输出到文件：
```bash
merkle -o result.txt /path/to/directory
```

显示详细信息（包括每个文件的哈希值）：
```bash
merkle -v /path/to/directory
```

使用 8 个工作线程并行计算：
```bash
merkle --workers 8 /path/to/directory
```

禁用并行计算：
```bash
merkle --disable-parallel /path/to/directory
```

## 性能考虑

- 对于大型目录或大文件，计算可能需要较长时间
- 使用较快的哈希算法（如 MD5, CRC32, BLAKE2B 或 SM3）可以提高性能，但可能降低安全性
- SHA256 是默认算法，在安全性和性能之间取得了良好平衡
- 并行处理可以显著提高计算速度，特别是对于包含大量文件的目录
- 默认情况下，工具会使用所有可用的 CPU 核心进行并行计算
- 可以通过 `--workers` 选项调整并行度，通常设置为可用 CPU 核心数或略高
- 对于资源受限的环境，可以使用 `--disable-parallel` 选项禁用并行计算

## 算法比较

| 算法 | 速度 | 安全性 | 哈希长度 | 适用场景 |
|------|------|--------|----------|----------|
| CRC32 | 极快 | 低 | 32 位 | 性能优先、非安全场景 |
| MD5 | 非常快 | 低 | 128 位 | 一般性能需求 |
| SHA1 | 快 | 中低 | 160 位 | 低安全性需求 |
| SHA256 | 中等 | 高 | 256 位 | 一般安全需求 |
| SHA512 | 慢 | 非常高 | 512 位 | 高安全性需求 |
| BLAKE2B | 快 | 高 | 可变（默认 512 位） | 性能与安全平衡 |
| SM3 | 中快 | 高 | 256 位 | 符合中国密码标准的应用 |

### CRC32 算法特别说明

CRC32 哈希算法优缺点:

**优点**:
- 计算速度极快，资源消耗低
- 对于意外数据损坏有良好的检测能力
- 特别适合嵌入式系统或资源受限环境

**缺点**:
- 安全性低，易于被故意碰撞或篡改
- 哈希长度短（32位），唯一性保证有限
- 不适合需要防篡改安全性的应用场景

**适用场景**:
- 数据完整性的简单检查
- 性能要求极高的场景
- 临时或内部使用的哈希需求

### SM3 算法特别说明

SM3 国密哈希算法优缺点:

**优点**:
- 符合中国商用密码标准
- 安全性高，抗碰撞性能良好
- 计算速度适中，比SHA256略快
- 适合需要符合中国密码标准的应用

**缺点**:
- 国际兼容性不如SHA系列
- 在非中国地区的生态支持相对较少

**适用场景**:
- 需要符合中国密码标准的应用
- 对中国市场的密码合规性要求
- 国内政务、金融等领域的密码应用

## 并行计算说明

本工具使用 Go 语言的 goroutine 实现并行计算，主要优化了两个部分：

1. **文件哈希计算并行化**：创建工作线程池同时处理多个文件的哈希计算
2. **Merkle 树构建并行化**：在构建树的每一层时并行计算节点哈希

**优势**：
- 充分利用多核处理器资源
- 对于大型目录，性能提升显著
- 可根据系统资源调整并行度

对于包含大量小文件的目录，并行计算可以带来 2-10 倍的性能提升，具体取决于CPU核心数和存储性能。

## 许可证

MIT 